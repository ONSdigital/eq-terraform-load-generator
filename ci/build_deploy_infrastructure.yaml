platform: linux
image_resource:
  type: docker-image
  source:
    repository: $BUILD_IMAGE_DOCKER_REGISTRY/eq-infrastructure-build-image
inputs:
  - name: eq-terraform-load-generator
run:
  path: bash
  args:
    - -exc
    - |

      cat >$GOOGLE_APPLICATION_CREDENTIALS <<EOL
      $SERVICE_ACCOUNT_JSON
      EOL

      gcloud auth activate-service-account --key-file $GOOGLE_APPLICATION_CREDENTIALS

      cd eq-terraform-load-generator

      tfenv use "$(< .terraform-version)"

      ./scripts/deploy_infrastructure.sh
params:
  - BUILD_IMAGE_DOCKER_REGISTRY: $BUILD_IMAGE_DOCKER_REGISTRY
